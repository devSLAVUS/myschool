# DevOps case by Slavus
###### Репозиторий подготовлен для теста: https://events.webinar.ru/course-info/66147
## Для запуска приложения понадобится:  
* Две виртуальные машины с системами debian на момент публикации это debian 11
1. Первая VM выступает в роли jenkins-сервера
1. На вторую VM выступающую в роли клиента требуется установить систему и открыть ssh доступ для пользователя root
## На сервере для дженкинса:
1. Установите git:  
`apt install -y git`  
2. Склонируйте репозиторий:  
git clone https://github.com/devSLAVUS/myschool.git
3. перейдите в папку со вспомогательными  скриптами 
`cd myschool/tool/`  
4. Разрешите выполнение  
`chmod +x alin.sh`  
5. Запустите    
`./alin.sh` 

Данный скрипт установит все необходимое: sudo, 
python3-venv, pip, django, txt2html, java, curl, docker, jenkins

На выходе вы получите ключ для jenkins
его необходимо ввести в браузере по адресу http://адрес вашего сервера:8080  
введите его, установите дженкинс с рекомендуемыми плагинами и создайте учетную запись администратора

Так же вы получите открытую часть ssh ключа, его необходимо добавить в  ~/.ssh/authorized_keys
на вашем продакшн сервере, для пользователя root.
После действий выше перезагрузите сервер
## После перезагрузки:  
1. Перейдите в папку со вспомогательными  скриптами  
`cd myschool/tool/`
2. Разрешите выполнение  
`chmod +x replace.sh`
3. Запустите:  
`./replace.sh`
4. И следуйте инструкциям
Данный скрипт подготовит задачу в дженкинсе, потребуется указать ваши данные, в некоторых пунктах будут подсказки в скобках, используйте их если собираете данный репозиторий, а не свой собственный
## Запуск задачи jenkins
Теперь можно запускать задачу, двумя способами
1. Через веб интерфейс дженкинса
2. С помощью скрипта:  
`cd myschool/tool/`  
`chmod +x runjob.sh`  
`./runjob.sh`  
## Структура:  
* Простое веб приложение написанное на python размещено: `django_school/`
* Jenkins-скрипт и вспомогательные скрипты: `tool/`  
## Используемые плагины jenkins  
К стандартным рекомендованым плагинам jenkins'a версии 2.303.3 дополнительно установлены:  
* Cobertura Plugin - для проверки покрытия кода
* Email Extension Plugin - для отправки уведомлений на почту
* HTML Publisher plugin - для создания отчета о безопасности образа
## Отправка писем  
Скрипт умеет отпралять письма на почту.    
Для этого необходимо в настройках системы jenkins'a в пунктах *Extended E-mail Notification* и *Уведомление почтой*
прописать настройки вашего smtp сервера, я использовал сервер яндекса.  
Письма будут отправлены на почту пользователя инициировавшего выполнение задачи в jenkins'е, она должна быть указана в настройках учетной записи.

## Дополнительная информация
в скрипте tool/docker_scan.sh используется переменная окружения $DTOKEN в которую необходимо указать API ключ утилиты docker scan  
Ключ можно получить тут https://snyk.io/ необходимо авторизоваться через учетную запись dockerhub и в настройках сгенерировать ключ

###### Последнее обновление: 14.11.2021
